------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  W:\C6_Fang\WMH\Projects\Yihui\Sexdiff_suicide\output/Figure1.log
  log type:  text
 opened on:  25 Dec 2024, 18:00:23

. 
. frame change default

. capture frame drop result1

. frame create result1 prd far year ir lb ub

. 
. 
. * Import data
. 
. use "data/data.dta", clear

. 
. *keep key variables
. keep lopnr prd entry exit sui_dt sa far agec cal

. 
. * code exit
. replace exit=exit+1 if entry==exit
(1,588 real changes made)

. 
. * code event
. gen fail=0

. replace fail=1 if exit==sui_dt & sa==1
(15,807 real changes made)

. 
. *pseudo id
. gen obs_id = _n

. 
. * set time
. stset exit, failure(fail==1) entry(time entry) exit(time exit) origin(time entry) id(obs_id)

Survival-time data settings

           ID variable: obs_id
         Failure event: fail==1
Observed time interval: (exit[_n-1], exit]
     Enter on or after: time entry
     Exit on or before: time exit
     Time for analysis: (time-origin)
                Origin: time entry

--------------------------------------------------------------------------
   12316262  total observations
          0  exclusions
--------------------------------------------------------------------------
   12316262  observations remaining, representing
   12316262  subjects
     15,807  failures in single-failure-per-subject data
 3.8533e+09  total analysis time at risk and under observation
                                                At risk from t =         0
                                     Earliest observed entry t =         0
                                          Last observed exit t =       365

. format _origin %td

. 
. *split by year
. di date("01/01/2001", "MDY")
14976

. *14976
. 
. *calculate interval between years
. foreach i of num 2002/2021{
  2.         di date("12/31/`i'", "MDY")-14976
  3. 
. }
729
1094
1460
1825
2190
2555
2921
3286
3651
4016
4382
4747
5112
5477
5843
6208
6573
6938
7304
7669

. 
. stsplit year, at(364 729 1094 1460 1825 2190 2555 2921 3286 3651 4016 4382 4747 5112 5477 5843 6208 6573 6
> 938 7304 7669) after(time=14976)
(10,335,565 observations (episodes) created)

. 
. replace year=year(_origin+_t) 
(22,651,827 real changes made)

. 
. *estimate follow-up time
. gen fu=_t - _t0

. 
. *collapse data
. collapse (sum) _d fu, by(agec year far prd)

. 
. * round person time (in days)
. gen py=round(fu/365.25)

. 
. * direct standardization
. gen strata=1

. 
. foreach i of num 0/1 {
  2.         foreach j of num 2001/2021 {
  3.                 foreach t of num 1/3 {
  4. 
.                            qui: count if far==`i' & year==`j' & prd==`t'
  5.                            if (r(N) > 0) {
  6.                qui: dstdize _d py agec if far==`i' & year==`j' & prd==`t', by(strata) using(data/stdpop
> 1)
  7.         
.                local b1= r(adj)[1,1]
  8.                local lb= r(lb_adj)[1,1]
  9.                local ub= r(ub_adj)[1,1]
 10.         
.                frame post result1  (`t') (`i') (`j') (`b1') (`lb') (`ub') 
 11.                            }
 12.         } 
 13.  } 
 14. } 

. 
. 
. *load result and merge 
. frame result1:list 

     +---------------------------------------------------+
     | prd   far   year         ir         lb         ub |
     |---------------------------------------------------|
  1. |   1     0   2001   .0020749   .0017326   .0024173 |
  2. |   2     0   2001   .0005616   .0003728   .0007505 |
  3. |   3     0   2001   .0006216   .0003985   .0008447 |
  4. |   1     0   2002    .001885   .0015727   .0021974 |
  5. |   2     0   2002   .0005591   .0003673   .0007509 |
     |---------------------------------------------------|
  6. |   3     0   2002   .0008358   .0006414   .0010303 |
  7. |   1     0   2003   .0023146   .0019453   .0026838 |
  8. |   2     0   2003   .0005329   .0003712   .0006947 |
  9. |   3     0   2003   .0010603   .0008538   .0012668 |
 10. |   1     0   2004    .002208   .0018389    .002577 |
     |---------------------------------------------------|
 11. |   2     0   2004   .0006667   .0004741   .0008593 |
 12. |   3     0   2004   .0007917   .0006151   .0009683 |
 13. |   1     0   2005   .0023929   .0020311   .0027547 |
 14. |   2     0   2005   .0007526   .0005518   .0009535 |
 15. |   3     0   2005    .000967   .0007667   .0011673 |
     |---------------------------------------------------|
 16. |   1     0   2006   .0022298   .0019042   .0025555 |
 17. |   2     0   2006   .0008217   .0006028   .0010407 |
 18. |   3     0   2006   .0008202   .0006467   .0009936 |
 19. |   1     0   2007    .002236   .0019464   .0025256 |
 20. |   2     0   2007   .0007449   .0005466   .0009432 |
     |---------------------------------------------------|
 21. |   3     0   2007   .0010236   .0008249   .0012223 |
 22. |   1     0   2008    .002537   .0022081    .002866 |
 23. |   2     0   2008    .000748   .0005568   .0009392 |
 24. |   3     0   2008   .0009626   .0007751   .0011501 |
 25. |   1     0   2009   .0024279   .0021054   .0027505 |
     |---------------------------------------------------|
 26. |   2     0   2009   .0007867   .0005928   .0009807 |
 27. |   3     0   2009   .0007902   .0006246   .0009557 |
 28. |   1     0   2010   .0024272   .0020899   .0027645 |
 29. |   2     0   2010   .0007537   .0005673   .0009402 |
 30. |   3     0   2010    .000927   .0007449    .001109 |
     |---------------------------------------------------|
 31. |   1     0   2011   .0020231   .0017138   .0023325 |
 32. |   2     0   2011   .0010226   .0007862   .0012591 |
 33. |   3     0   2011   .0011319   .0009276   .0013362 |
 34. |   1     0   2012   .0020764   .0017691   .0023838 |
 35. |   2     0   2012   .0008293   .0006324   .0010261 |
     |---------------------------------------------------|
 36. |   3     0   2012   .0008434   .0006687   .0010182 |
 37. |   1     0   2013    .002267   .0019634   .0025707 |
 38. |   2     0   2013   .0006852   .0005041   .0008663 |
 39. |   3     0   2013   .0007453   .0005788   .0009117 |
 40. |   1     0   2014    .001802   .0015121   .0020918 |
     |---------------------------------------------------|
 41. |   2     0   2014   .0007755     .00057   .0009809 |
 42. |   3     0   2014     .00081   .0006393   .0009808 |
 43. |   1     0   2015   .0022143   .0018934   .0025352 |
 44. |   2     0   2015   .0005221   .0003591   .0006851 |
 45. |   3     0   2015   .0006461   .0004935   .0007988 |
     |---------------------------------------------------|
 46. |   1     0   2016   .0019707   .0016759   .0022655 |
 47. |   2     0   2016   .0007875   .0005887   .0009863 |
 48. |   3     0   2016   .0008676   .0006946   .0010407 |
 49. |   1     0   2017   .0019127   .0016219   .0022035 |
 50. |   2     0   2017   .0007735   .0005817   .0009654 |
     |---------------------------------------------------|
 51. |   3     0   2017   .0008454   .0006678   .0010229 |
 52. |   1     0   2018   .0017496   .0014629   .0020364 |
 53. |   2     0   2018   .0007157   .0005222   .0009091 |
 54. |   3     0   2018   .0008333   .0006555   .0010111 |
 55. |   1     0   2019   .0021338   .0018271   .0024405 |
     |---------------------------------------------------|
 56. |   2     0   2019   .0005188    .000366   .0006716 |
 57. |   3     0   2019   .0007111   .0005517   .0008705 |
 58. |   1     0   2020   .0018534   .0015029   .0022039 |
 59. |   2     0   2020   .0005319   .0003625   .0007014 |
 60. |   3     0   2020   .0006186   .0004664   .0007707 |
     |---------------------------------------------------|
 61. |   1     0   2021   .0020806          0    .004309 |
 62. |   2     0   2021   .0003672   .0001918   .0005426 |
 63. |   3     0   2021   .0006473   .0004787   .0008158 |
 64. |   1     1   2001   .0012381    .000989   .0014871 |
 65. |   2     1   2001   .0011428   .0008575   .0014282 |
     |---------------------------------------------------|
 66. |   3     1   2001   .0011097   .0007385   .0014808 |
 67. |   1     1   2002   .0016251   .0013379   .0019123 |
 68. |   2     1   2002    .001482   .0011767   .0017873 |
 69. |   3     1   2002   .0016548   .0013553   .0019543 |
 70. |   1     1   2003   .0019203   .0016065   .0022341 |
     |---------------------------------------------------|
 71. |   2     1   2003   .0016108   .0012876   .0019341 |
 72. |   3     1   2003   .0015213   .0012409   .0018018 |
 73. |   1     1   2004   .0019492    .001635   .0022633 |
 74. |   2     1   2004   .0016418   .0013153   .0019684 |
 75. |   3     1   2004    .001946   .0016224   .0022695 |
     |---------------------------------------------------|
 76. |   1     1   2005   .0022893   .0019529   .0026258 |
 77. |   2     1   2005   .0015759   .0012572   .0018946 |
 78. |   3     1   2005   .0020728   .0017217    .002424 |
 79. |   1     1   2006   .0019367   .0016292   .0022441 |
 80. |   2     1   2006   .0017221   .0013891   .0020552 |
     |---------------------------------------------------|
 81. |   3     1   2006   .0016134   .0013077   .0019191 |
 82. |   1     1   2007   .0021892   .0018653    .002513 |
 83. |   2     1   2007   .0016996   .0013751   .0020241 |
 84. |   3     1   2007   .0021089   .0017602   .0024577 |
 85. |   1     1   2008   .0022888   .0019634   .0026142 |
     |---------------------------------------------------|
 86. |   2     1   2008    .001998   .0016513   .0023446 |
 87. |   3     1   2008   .0023788   .0020197   .0027378 |
 88. |   1     1   2009   .0020665   .0017577   .0023754 |
 89. |   2     1   2009   .0020738   .0017273   .0024203 |
 90. |   3     1   2009   .0018923   .0015857    .002199 |
     |---------------------------------------------------|
 91. |   1     1   2010   .0020417   .0017319   .0023515 |
 92. |   2     1   2010   .0021079   .0017626   .0024532 |
 93. |   3     1   2010   .0020008   .0016801   .0023216 |
 94. |   1     1   2011   .0021819   .0018617   .0025021 |
 95. |   2     1   2011   .0016377   .0013299   .0019455 |
     |---------------------------------------------------|
 96. |   3     1   2011   .0020839   .0017595   .0024084 |
 97. |   1     1   2012   .0020123   .0017064   .0023181 |
 98. |   2     1   2012   .0015896    .001279   .0019002 |
 99. |   3     1   2012   .0017928   .0014903   .0020953 |
100. |   1     1   2013   .0022382   .0019147   .0025618 |
     |---------------------------------------------------|
101. |   2     1   2013   .0016386   .0013301    .001947 |
102. |   3     1   2013   .0014992   .0012264    .001772 |
103. |   1     1   2014   .0018534   .0015583   .0021485 |
104. |   2     1   2014   .0017293   .0014093   .0020494 |
105. |   3     1   2014   .0019236   .0015805   .0022667 |
     |---------------------------------------------------|
106. |   1     1   2015   .0015446   .0012769   .0018123 |
107. |   2     1   2015   .0015014   .0012145   .0017883 |
108. |   3     1   2015   .0018283   .0014801   .0021765 |
109. |   1     1   2016   .0021294   .0018101   .0024486 |
110. |   2     1   2016   .0014684   .0011743   .0017625 |
     |---------------------------------------------------|
111. |   3     1   2016   .0017702   .0014631   .0020772 |
112. |   1     1   2017   .0018944   .0015903   .0021985 |
113. |   2     1   2017   .0016691   .0013164   .0020218 |
114. |   3     1   2017    .001997   .0016633   .0023307 |
115. |   1     1   2018   .0016803   .0013836   .0019771 |
     |---------------------------------------------------|
116. |   2     1   2018   .0015969   .0012681   .0019257 |
117. |   3     1   2018   .0017272   .0014124    .002042 |
118. |   1     1   2019   .0017126   .0014006   .0020247 |
119. |   2     1   2019   .0011647   .0008726   .0014567 |
120. |   3     1   2019   .0018152   .0014357   .0021946 |
     |---------------------------------------------------|
121. |   1     1   2020   .0017276   .0013467   .0021085 |
122. |   2     1   2020   .0014997   .0011427   .0018568 |
123. |   3     1   2020   .0016565   .0012679   .0020451 |
124. |   1     1   2021   .0009285          0   .0022223 |
125. |   2     1   2021    .000983   .0006382   .0013279 |
     |---------------------------------------------------|
126. |   3     1   2021   .0012017   .0008441   .0015594 |
     +---------------------------------------------------+

. frame change result1

. save output/figure1,replace
file output/figure1.dta saved

. 
. *import datasets
. use output/figure1,clear

. 
. *replace ir, lb and ub
. replace ir=ir*1000
(126 real changes made)

. replace lb=lb*1000
(124 real changes made)

. replace ub=ub*1000
(126 real changes made)

. 
. *label of prd
. label define prdlab 1 "Preconception" 2 "Antepartum" 3 "Postpartum"

. label values prd prdlab

. 
. 
. *generate smoothed ci using lowess
. foreach i of num 0/1 {
  2.         foreach j of num 1/3{
  3.                 
.                 lowess lb year if far==`i' & prd==`j', gen(lbs`i'`j') nograph
  4.         lowess ub year if far==`i' & prd==`j', gen(ubs`i'`j') nograph
  5.         lowess ir year if far==`i' & prd==`j', nograph gen(irs`i'`j')
  6. 
.                 }
  7. }

. 
. gen lbs=min(lbs01,lbs02,lbs03,lbs11,lbs12,lbs13)

. gen ubs=min(ubs01,ubs02,ubs03,ubs11,ubs12,ubs13)

. gen irs=min(irs01,irs02,irs03,irs11,irs12,irs13)

. 
. * plot 
. twoway ///
>         (rarea lbs ubs year if far==0 , color(pink) lw(none) fi(inten10)) ///
>         (rarea lbs ubs year if far==1 , color(ltblue) lw(none) fi(inten20)) ///
>     (scatter ir year if far==0 , msymbol(O) mcolor(red) sort) /// 
>         (line irs year if far==0 , color(pink)  fi(inten10)) ///
>         (scatter ir year if far==1 , msymbol(O) mcolor(midblue) sort) ///
>         (line irs year if far==1 , color(navy)  fi(inten10)), ///
> by(prd, rows(1) ixaxes iyaxes graphregion(color(white)) note("") legend(position(6))) ///
> legend(order(4 6) lab(4 "Mothers") lab (6 "Fathers") rows(1) region(lcolor(white)) size(vsmall)) graphregi
> on(color(white)) ///
> ylabel(0(1)2, grid angle(0)) ///
> xlabel(2001(5)2021) ///
> ytitle("Standardized incidence rate per 1,000 person-years",size(small)) ///
> xtitle("Calendar year",size(small)) ///
> saving(output/figure1,replace) 
file output/figure1.gph saved

. 
. 
. * output
. graph use output/figure1

. graph export output/figure1.jpg, replace
file output/figure1.jpg written in JPEG format

. 
. log close
      name:  <unnamed>
       log:  W:\C6_Fang\WMH\Projects\Yihui\Sexdiff_suicide\output/Figure1.log
  log type:  text
 closed on:  25 Dec 2024, 18:09:13
------------------------------------------------------------------------------------------------------------
